jQuery(function(_){"use strict";var f=function(t){return Math.abs(parseInt(t,10))||0},h=function(){var t,o=arguments[0],a=Array.prototype.slice.call(arguments).slice(1);for(t in a)var e=a[t],o=o.replace("%s",e);return o},p=function(){return Array.prototype.slice.call(arguments).filter(function(t){return t.length}).shift()},g=bk.blockParams,a=bk.blockParamsEmpty,b="on-form-update"===yith_booking_form_params.form_error_handling,k="on-button-click"===yith_booking_form_params.form_error_handling,y=function(t,o){var a,e,i="";return i=o in bk.i18n_durations?h((a=bk.i18n_durations[o].singular,o=bk.i18n_durations[o].plural,e=t,(e=isNaN(e)?0:e)<2?a:o),t):i},v=function(t,o){return"string"==typeof o&&(o=[o]),void 0!==t.find(function(t){return-1<o.indexOf(t.key)})};_.fn.yith_booking_form=function(){var u={form:_(this).closest(".yith-wcbk-booking-form"),dom:{},ajaxCall:null},i=(u.productID=u.form.data("product-id"),u.bookingData=u.form.data("booking_data"),u.dom={duration:u.form.find(".yith-wcbk-booking-duration"),realDuration:u.form.find(".yith-wcbk-booking-real-duration"),persons:u.form.find(".yith-wcbk-booking-persons"),personTypes:u.form.find(".yith-wcbk-booking-person-types"),optionalServices:u.form.find("input[type=checkbox].yith-wcbk-booking-service"),serviceQuantities:u.form.find("input.yith-wcbk-booking-service-quantity"),startDate:u.form.find(".yith-wcbk-booking-start-date"),from:u.form.find(".yith-wcbk-booking-hidden-from"),endDate:u.form.find(".yith-wcbk-booking-end-date"),message:u.form.find(".yith-wcbk-booking-form-message"),totals:u.form.find(".yith-wcbk-booking-form-totals"),totalsSection:u.form.find(".yith-wcbk-form-section-totals"),additionalData:u.form.find(".yith-wcbk-booking-form-additional-data"),time:u.form.find(".yith-wcbk-booking-start-date-time"),addToCart:u.form.closest("form").find("button[type=submit]"),addToQuote:_(".add-request-quote-button").first(),prices:u.form.closest(yith_booking_form_params.dom.product_container).find(yith_booking_form_params.dom.price)},u.dom.price="yes"!==yith_booking_form_params.price_first_only?u.dom.prices:u.dom.prices.first(),u.dom.timeWrap=u.dom.time.closest(".yith-wcbk-form-section"),u.getDuration=function(){return u.bookingData.duration},u.getDurationUnit=function(){return u.bookingData.duration_unit},u.getMinimumDuration=function(){return u.bookingData.minimum_duration},u.getMaximumDuration=function(){return u.bookingData.maximum_duration},u.getMinimumPeople=function(){return u.bookingData.minimum_number_of_people},u.getMaximumPeople=function(){return u.bookingData.maximum_number_of_people},u.getFormattedDuration=function(t){return y(t,u.getDurationUnit())},u.hasDuration=function(){return!!u.dom.duration.length},u.isDurationUnit=function(t){return"string"==typeof t?t===u.getDurationUnit():t.includes(u.getDurationUnit())},u.isFullDay=function(){return"yes"===u.bookingData.full_day},u.hasTime=function(){return u.isDurationUnit(["hour","minute"])},u.hasPeople=function(){return!!u.dom.persons.length||u.hasPersonTypes()},u.hasPersonTypes=function(){return!!u.dom.personTypes.length},u.hasOptionalServices=function(){return!!u.dom.optionalServices.length},u.updateTotalsHtml=function(t){t?u.dom.totalsSection.show():u.dom.totalsSection.hide(),u.dom.totals.html(t)},u.updateMessageHtml=function(t){t?u.dom.message.show():u.dom.message.hide(),u.dom.message.html(t)},function(){return u.form.find(".yith-wcbk-booking-form-error").length}),n=function(){u.form.find(".yith-wcbk-booking-form-error").remove(),u.form.find(".yith-wcbk-form-section__content--with-error").removeClass("yith-wcbk-form-section__content--with-error")},r=function(t){for(var o in n(),t){var a,o=t[o];o.message&&o.field&&(a=_('<div class="yith-wcbk-booking-form-error">'+o.message+"</div>"),o.field.closest(".yith-wcbk-form-section__content").addClass("yith-wcbk-form-section__content--with-error").append(a))}},d=function(){var t=f(u.dom.duration.val()),o=f(u.dom.persons.val()),a=u.dom.startDate.val(),e=a,i=u.dom.endDate.val(),n=o,r=u.dom.time.val(),d=!0,m={},s=[],l=(u.dom.from.length&&(r?u.dom.from.val(a+" "+r):u.dom.from.val(a),e=u.dom.from.val()),u.hasPersonTypes()&&(n=0,u.dom.personTypes.each(function(){n+=_(this).val()<1?0:parseInt(_(this).val(),10)})),u.hasDuration()&&!t&&(s.push({key:"empty-duration",field:u.dom.duration,message:yith_booking_form_params.i18n_empty_duration}),d=!1),e&&i&&u.isDurationUnit("day")&&(t=yith_wcbk_dates.date_diff(i,e,"days"),u.isFullDay())&&(t+=1),(!a||0<u.dom.endDate.length&&!i)&&(u.hasTime()?s.push({key:"empty-date-for-time",field:u.dom.startDate,message:yith_booking_form_params.i18n_empty_date_for_time}):s.push({key:"empty-date",field:p(u.dom.endDate,u.dom.startDate),message:yith_booking_form_params.i18n_empty_date}),d=!1),u.hasTime()&&a&&!r&&(s.push({key:"empty-time",field:u.dom.time,message:yith_booking_form_params.i18n_empty_time}),d=!1),u.hasPeople()&&(n<u.getMinimumPeople()&&(s.push({key:"minimum-people",field:u.hasPersonTypes()?u.dom.personTypes.last():u.dom.persons,message:h(yith_booking_form_params.i18n_min_persons,u.getMinimumPeople())}),d=!1),0<u.getMaximumPeople())&&n>u.getMaximumPeople()&&(s.push({key:"maximum-people",field:u.hasPersonTypes()?u.dom.personTypes.last():u.dom.persons,message:h(yith_booking_form_params.i18n_max_persons,u.getMaximumPeople())}),d=!1),0<u.getMinimumDuration()&&t<u.getMinimumDuration()&&(v(s,["empty-duration","empty-date"])||s.push({key:"minimum-duration",field:p(u.dom.duration,u.dom.endDate,u.dom.startDate),message:h(yith_booking_form_params.i18n_min_duration,u.getFormattedDuration(u.getMinimumDuration()))}),d=!1),u.getMaximumDuration()&&t>u.getMaximumDuration()&&(v(s,["empty-duration","empty-date"])||s.push({key:"maximum-duration",field:p(u.dom.duration,u.dom.endDate,u.dom.startDate),message:h(yith_booking_form_params.i18n_max_duration,u.getFormattedDuration(u.getMaximumDuration()))}),d=!1),[]),c=[];return u.hasPersonTypes()&&u.dom.personTypes.each(function(){l.push({id:_(this).data("person-type-id"),number:_(this).val()})}),u.hasOptionalServices()&&u.dom.optionalServices.each(function(){_(this).is(":checked")&&c.push(_(this).data("service-id"))}),m={product_id:u.productID,duration:t,from:e,from_date:a,time:r,to:i,persons:o,person_types:l,booking_services:c},u.dom.serviceQuantities.length&&u.dom.serviceQuantities.each(function(){var t=_(this).attr("name"),o=_(this).val();t.length&&(m[t]=o)}),u.dom.additionalData.length&&u.dom.additionalData.each(function(){var t=_(this),o=t.attr("name"),a=t.val(),t=!t.is("input[type=checkbox]")||t.is(":checked"),e="[]"===o.substring(o.length-2,o.length);t&&o.length&&(e?o in m?m[o].push(a):m[o]=Array.isArray(a)?a:[a]:m[o]=a)}),{errors:s,validation:d,formData:m}},m=function(t){t?(u.dom.addToCart.removeClass("yith-wcbk-not-allowed"),u.dom.addToQuote.removeClass("yith-wcbk-not-allowed")):(u.dom.addToCart.addClass("yith-wcbk-not-allowed"),u.dom.addToQuote.addClass("yith-wcbk-not-allowed")),!b||t?(u.dom.addToCart.attr("disabled",!1),u.dom.addToQuote.removeClass("disabled")):(u.dom.addToCart.attr("disabled",!0),u.dom.addToQuote.addClass("disabled")),u.form.trigger("yith_wcbk_booking_form_add_to_cart_enabled_status_updated",[t])},s=function(t){t?(u.dom.totals.html()&&u.dom.totals.block(g),u.dom.message.html()&&u.dom.message.block(g),u.dom.price.block(g),u.dom.addToCart.block(a),u.dom.addToQuote.block(a)):(u.dom.message.unblock(),u.dom.price.unblock(),u.dom.addToCart.unblock(),u.dom.addToQuote.unblock())},t=function(t){_(this).is(".yith-wcbk-not-allowed")&&t.preventDefault(),k&&(n(),(t=d()).validation||r(t.errors))},e=function(o){o=void 0!==o?o:{},o=_.extend({},{updateFormOnCompleteOnlyIfValid:!1},o);var t=!1,a=d(),e=a.formData.duration||0,i=a.formData.from_date||!1,n=a.formData.time||!1,a=a.formData;return u.hasTime()&&i&&e&&(a.request="get_booking_available_times",u.ajaxCall&&u.ajaxCall.abort(),t=!0,u.ajaxCall=yith_booking.ajax(a,{block:u.dom.time.parent()}),u.ajaxCall.done(function(t){var o,t=t.data;try{t.error?u.dom.message.html('<p class="error">'+t.error+"</p>"):(t.time_data_html&&u.dom.time.html(t.time_data_html),n&&(o=u.dom.time.find('option[value="'+n+'"]'))&&o.attr("selected","selected"),t.message&&u.dom.message.html("<p>"+t.message+"</p>"),u.dom.time.trigger("yith-wcbk-select-list:update"),u.form.trigger("yith_wcbk_form_update_time",t))}catch(a){console.log(a)}}).always(function(){var t=d();o.updateFormOnCompleteOnlyIfValid&&!t.validation||u.form.trigger("yith_wcbk_booking_form_update")})),t},l=function(t){return!(!b||(t="undefined"!=typeof t.target&&t.target)&&t.is(".yith-wcbk-booking-start-date")&&u.dom.endDate.length&&!u.dom.endDate.val())},c=function(){u.hasTime()&&(u.dom.startDate.val()?u.dom.timeWrap.show():u.dom.timeWrap.hide())},o=function(a,e){var t=d().formData,i={notAvailableDates:a.data("not-available-dates")||[]};t.request="get_product_non_available_dates",yith_booking.ajax(t).done(function(t){t=t.data;try{t.error?console.log(t.error):(a.data("month-to-load",t.month_to_load),a.data("year-to-load",t.year_to_load),a.data("not-available-dates",i.notAvailableDates.concat(t.not_available_dates)),a.data("loaded-months",i.loadedMonths.concat(t.loaded_months)),a.datepicker("refresh"))}catch(o){console.log(o.message)}e()})};u.updateTotalsHtml(""),m(!1),u.dom.addToCart.on("click",t),u.dom.addToQuote.on("click",t),u.dom.realDuration.on("change",function(){var t=Math.floor(u.dom.realDuration.val()/u.getDuration());u.dom.duration.val(t).trigger("change")}),u.form.on("yith_wcbk_booking_form_update",function(t,o){var a=i(),e=d();o=void 0!==o?o:{},n(),e.validation?(s(!0),e.formData.request="get_booking_data",u.ajaxCall&&u.ajaxCall.abort(),u.ajaxCall=yith_booking.ajax(e.formData),u.ajaxCall.done(function(t){var o=t.data;try{o.error?u.updateMessageHtml('<p class="error">'+t.error+"</p>"):(o.message?u.updateMessageHtml(o.message):u.updateMessageHtml(""),o.totals_html?u.updateTotalsHtml(o.totals_html):u.updateTotalsHtml(""),o.price&&0<o.price.length&&u.dom.price.html(o.price),m(!!o.is_available),u.form.trigger("yith_wcbk_form_update_response",o))}catch(a){console.log(a.message)}}).always(function(t,o){"abort"!==o&&s(!1)})):(u.updateMessageHtml(""),u.updateTotalsHtml(""),(a||l(o))&&r(e.errors),m(!1))}),u.form.on("yith_wcbk_booking_form_loaded",function(){var t=!e({updateFormOnCompleteOnlyIfValid:!0});c(),t&&d().validation&&u.form.trigger("yith_wcbk_booking_form_update")}),u.form.on("yith_wcbk_booking_form_update_time_slots",e),u.form.on("yith_wcbk_datepicker_update_non_available_dates",".yith-wcbk-date-picker",function(t,a,e){var i=_(this),o=d().formData;_("#ui-datepicker-div").block(g),o.month=e.month_to_load,o.year=e.year_to_load,o.request="get_product_non_available_dates",yith_booking.ajax(o).done(function(t){t=t.data;try{t.error?console.log(t.error):(a.data("month-to-load",t.month_to_load),a.data("year-to-load",t.year_to_load),a.data("not-available-dates",e.notAvailableDates.concat(t.not_available_dates)),a.data("loaded-months",e.loadedMonths.concat(t.loaded_months)),_("#ui-datepicker-div").unblock(),i.datepicker("refresh"))}catch(o){console.log(o.message)}})}),u.form.on("yith_wcbk_datepicker_load_non_available_dates_in_month",".yith-wcbk-date-picker",function(t,a,e,o,i){var n=_(this),r=d().formData;r.year=o,r.month=i,r.months_to_load=1,r.request="get_product_non_available_dates",_("#ui-datepicker-div").block(g),yith_booking.ajax(r).done(function(t){t=t.data;try{t.error?console.log(t.error):(a.data("not-available-dates",e.notAvailableDates.concat(t.not_available_dates)),a.data("loaded-months",e.loadedMonths.concat(t.loaded_months)),_("#ui-datepicker-div").unblock(),n.datepicker("refresh"))}catch(o){console.log(o.message)}})}),u.form.on("change","input, select, .yith-wcbk-date-picker--inline",function(t){var o=_(t.target),a=!0;!o.is(".yith-wcbk-booking-real-duration")&&(c(),a=o.is(".yith-wcbk-booking-start-date")||o.is(".yith-wcbk-booking-duration")?!e():a)&&u.form.trigger("yith_wcbk_booking_form_update",[{target:o,event:t}])}),!yith_booking_form_params.is_admin&&"yes"===yith_booking_form_params.ajax_update_non_available_dates_on_load&&u.dom.startDate.is(".yith-wcbk-date-picker")?(u.dom.startDate.parent().block(g),o(u.dom.startDate,function(){u.dom.startDate.parent().unblock(),u.form.trigger("yith_wcbk_booking_form_loaded")})):u.form.trigger("yith_wcbk_booking_form_loaded")},_(document).on("yith-wcbk-init-booking-form",function(){var t=_(".yith-wcbk-date-picker"),o=_(".yith-wcbk-booking-form"),a=_(".yith-wcbk-people-selector"),e=_(".yith-wcbk-month-picker-wrapper");t.yith_wcbk_datepicker(),e.yith_wcbk_monthpicker(),a.each(function(){_(this).yith_wcbk_people_selector()}),o.each(function(){_(this).yith_booking_form()}),_(document).trigger("yith-wcbk-booking-form-initialized")}).trigger("yith-wcbk-init-booking-form"),_(document).on("qv_loader_stop",function(){_(document).trigger("yith-wcbk-init-booking-form"),_(document).trigger("yith-wcbk-init-fields:selector"),_(document).trigger("yith-wcbk-init-fields:help-tip"),_(document).trigger("yith-wcbk-init-fields:select-list")})});